<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebRTC DataChannel - Two Peer Demo</title>

    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body>
    <p id="servercode">...</p>
    <button onclick="sendMessage()">Send Message</button>
    <p id="messages"></p>

    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script src="src/Server.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get("code");

      let server;
      let peer;
      let conn;
      let clientID;
      let smallID;

      if (code == null) {
        server = new Server((code) => {
          console.log("Server up on client with code: " + code);
          setup(code);
        });
      } else {
        setup(code);
      }

      function setup(code) {
        peer = new Peer();

        peer.on("open", function (id) {
          clientID = id;
          smallID = clientID.split("-")[0];

          conn = peer.connect(code);
          console.log("CODE is " + code);

          conn.on("open", function () {
            console.log("Opened connected from " + id);
            conn.send(smallID + " connected.");
          });

          conn.on("data", function (data) {
            document.getElementById("messages").innerText = data;
          });
        });
      }

      function sendMessage() {
        conn.send(smallID + " >>> " + prompt("Message?"));
      }
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebRTC DataChannel - Two Peer Demo</title>

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <p id="servercode">...</p>
    <p id="turn">Turn:</p>

    <canvas id="canvas" width="800" height="800"></canvas>

    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script type="module">
      import { Server } from "./src/Server.js";
      import { Client } from "./src/Client.js";
      import { ClientInterface } from "./src/ClientInterface.js";

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const turnText = document.getElementById("turn");

      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get("code");

      let server;
      let client;
      let clientInterface;

      if (code == null) {
        server = new Server().then((code) => {
          console.log("Server up on client with code: " + code);
          document.getElementById("servercode").innerText = code;
          setup(code);
        });
      } else {
        setup(code);
      }

      function setup(code) {
        clientInterface = new ClientInterface(canvas);

        client = new Client(code).onDataReceived((data) => {
          turnText.innerText = "Turn: " + data.turn;
          clientInterface.render(data, client.clientID);
        });

        clientInterface.setSendMovement((x, y) => {
          client.sendMovement(x, y);
        });
      }

      window.requestAnimationFrame(gameLoop);
      function gameLoop() {
        if (server != null) {
          server.gameLoop();
        }

        window.requestAnimationFrame(gameLoop);
      }
    </script>
  </body>
</html>
